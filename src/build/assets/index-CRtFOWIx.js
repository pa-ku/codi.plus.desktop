"stream"in Blob.prototype||Object.defineProperty(Blob.prototype,"stream",{value(){return new Response(this).body}}),"setBigUint64"in DataView.prototype||Object.defineProperty(DataView.prototype,"setBigUint64",{value(t,n,e){const i=Number(0xffffffffn&n),r=Number(n>>32n);this.setUint32(t+(e?0:4),i,e),this.setUint32(t+(e?4:0),r,e)}});var U=t=>new DataView(new ArrayBuffer(t)),u=t=>new Uint8Array(t.buffer||t),y=t=>new TextEncoder().encode(String(t)),c=t=>Math.min(4294967295,Number(t)),B=t=>Math.min(65535,Number(t));function D(t,n){if(n===void 0||n instanceof Date||(n=new Date(n)),t instanceof File)return{isFile:1,t:n||new Date(t.lastModified),i:t.stream()};if(t instanceof Response)return{isFile:1,t:n||new Date(t.headers.get("Last-Modified")||Date.now()),i:t.body};if(n===void 0)n=new Date;else if(isNaN(n))throw new Error("Invalid modification date.");if(t===void 0)return{isFile:0,t:n};if(typeof t=="string")return{isFile:1,t:n,i:y(t)};if(t instanceof Blob)return{isFile:1,t:n,i:t.stream()};if(t instanceof Uint8Array||t instanceof ReadableStream)return{isFile:1,t:n,i:t};if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))return{isFile:1,t:n,i:u(t)};if(Symbol.asyncIterator in t)return{isFile:1,t:n,i:v(t[Symbol.asyncIterator]())};throw new TypeError("Unsupported input format.")}function v(t,n=t){return new ReadableStream({async pull(e){let i=0;for(;e.desiredSize>i;){const r=await t.next();if(!r.value){e.close();break}{const o=S(r.value);e.enqueue(o),i+=o.byteLength}}},cancel(e){var i;(i=n.throw)==null||i.call(n,e)}})}function S(t){return typeof t=="string"?y(t):t instanceof Uint8Array?t:u(t)}function I(t,n,e){let[i,r]=function(o){return o?o instanceof Uint8Array?[o,1]:ArrayBuffer.isView(o)||o instanceof ArrayBuffer?[u(o),1]:[y(o),0]:[void 0,0]}(n);if(t instanceof File)return{o:w(i||y(t.name)),u:BigInt(t.size),l:r};if(t instanceof Response){const o=t.headers.get("content-disposition"),f=o&&o.match(/;\s*filename\*?=["']?(.*?)["']?$/i),a=f&&f[1]||t.url&&new URL(t.url).pathname.split("/").findLast(Boolean),l=a&&decodeURIComponent(a),g=e||+t.headers.get("content-length");return{o:w(i||y(l)),u:BigInt(g),l:r}}return i=w(i,t!==void 0||e!==void 0),typeof t=="string"?{o:i,u:BigInt(y(t).length),l:r}:t instanceof Blob?{o:i,u:BigInt(t.size),l:r}:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?{o:i,u:BigInt(t.byteLength),l:r}:{o:i,u:R(t,e),l:r}}function R(t,n){return n>-1?BigInt(n):t?void 0:0n}function w(t,n=1){if(!t||t.every(e=>e===47))throw new Error("The file must have a name.");if(n)for(;t[t.length-1]===47;)t=t.subarray(0,-1);else t[t.length-1]!==47&&(t=new Uint8Array([...t,47]));return t}var F=new Uint32Array(256);for(let t=0;t<256;++t){let n=t;for(let e=0;e<8;++e)n=n>>>1^(1&n&&3988292384);F[t]=n}function b(t,n=0){n^=-1;for(var e=0,i=t.length;e<i;e++)n=n>>>8^F[255&n^t[e]];return(-1^n)>>>0}function A(t,n,e=0){const i=t.getSeconds()>>1|t.getMinutes()<<5|t.getHours()<<11,r=t.getDate()|t.getMonth()+1<<5|t.getFullYear()-1980<<9;n.setUint16(e,i,1),n.setUint16(e+2,r,1)}function L({o:t,l:n},e){return 8*(!n||(e??function(i){try{M.decode(i)}catch{return 0}return 1}(t)))}var M=new TextDecoder("utf8",{fatal:1});function N(t,n=0){const e=U(30);return e.setUint32(0,1347093252),e.setUint32(4,754976768|n),A(t.t,e,10),e.setUint16(26,t.o.length,1),u(e)}async function*E(t){let{i:n}=t;if("then"in n&&(n=await n),n instanceof Uint8Array)yield n,t.m=b(n,0),t.u=BigInt(n.length);else{t.u=0n;const e=n.getReader();for(;;){const{value:i,done:r}=await e.read();if(r)break;t.m=b(i,t.m),t.u+=BigInt(i.length),yield i}}}function T(t,n){const e=U(16+(n?8:0));return e.setUint32(0,1347094280),e.setUint32(4,t.isFile?t.m:0,1),n?(e.setBigUint64(8,t.u,1),e.setBigUint64(16,t.u,1)):(e.setUint32(8,c(t.u),1),e.setUint32(12,c(t.u),1)),u(e)}function z(t,n,e=0,i=0){const r=U(46);return r.setUint32(0,1347092738),r.setUint32(4,755182848),r.setUint16(8,2048|e),A(t.t,r,12),r.setUint32(16,t.isFile?t.m:0,1),r.setUint32(20,c(t.u),1),r.setUint32(24,c(t.u),1),r.setUint16(28,t.o.length,1),r.setUint16(30,i,1),r.setUint16(40,t.isFile?33204:16893,1),r.setUint32(42,c(n),1),u(r)}function V(t,n,e){const i=U(e);return i.setUint16(0,1,1),i.setUint16(2,e-4,1),16&e&&(i.setBigUint64(4,t.u,1),i.setBigUint64(12,t.u,1)),i.setBigUint64(e-8,n,1),u(i)}function x(t){return t instanceof File||t instanceof Response?[[t],[t]]:[[t.input,t.name,t.size],[t.input,t.lastModified]]}var C=t=>function(n){let e=BigInt(22),i=0n,r=0;for(const o of n){if(!o.o)throw new Error("Every file must have a non-empty name.");if(o.u===void 0)throw new Error(`Missing size for file "${new TextDecoder().decode(o.o)}".`);const f=o.u>=0xffffffffn,a=i>=0xffffffffn;i+=BigInt(46+o.o.length+(f&&8))+o.u,e+=BigInt(o.o.length+46+(12*a|28*f)),r||(r=f)}return(r||i>=0xffffffffn)&&(e+=BigInt(76)),e+i}(function*(n){for(const e of n)yield I(...x(e)[0])}(t));function k(t,n={}){const e={"Content-Type":"application/zip","Content-Disposition":"attachment"};return(typeof n.length=="bigint"||Number.isInteger(n.length))&&n.length>0&&(e["Content-Length"]=String(n.length)),n.metadata&&(e["Content-Length"]=String(C(n.metadata))),new Response(j(t,n),{headers:e})}function j(t,n={}){const e=function(i){var o;const r=i[Symbol.iterator in i?Symbol.iterator:Symbol.asyncIterator]();return{async next(){const f=await r.next();if(f.done)return f;const[a,l]=x(f.value);return{done:0,value:Object.assign(D(...l),I(...a))}},throw:(o=r.throw)==null?void 0:o.bind(r),[Symbol.asyncIterator](){return this}}}(t);return v(async function*(i,r){const o=[];let f=0n,a=0n,l=0;for await(const s of i){const m=L(s,r.buffersAreUTF8);yield N(s,m),yield s.o,s.isFile&&(yield*E(s));const h=s.u>=0xffffffffn,p=12*(f>=0xffffffffn)|28*h;yield T(s,h),o.push(z(s,f,m,p)),o.push(s.o),p&&o.push(V(s,f,p)),h&&(f+=8n),a++,f+=BigInt(46+s.o.length)+s.u,l||(l=h)}let g=0n;for(const s of o)yield s,g+=BigInt(s.length);if(l||f>=0xffffffffn){const s=U(76);s.setUint32(0,1347094022),s.setBigUint64(4,BigInt(44),1),s.setUint32(12,755182848),s.setBigUint64(24,a,1),s.setBigUint64(32,a,1),s.setBigUint64(40,g,1),s.setBigUint64(48,f,1),s.setUint32(56,1347094023),s.setBigUint64(64,f+g,1),s.setUint32(72,1,1),yield u(s)}const d=U(22);d.setUint32(0,1347093766),d.setUint16(8,B(a),1),d.setUint16(10,B(a),1),d.setUint32(12,c(g),1),d.setUint32(16,c(f),1),yield u(d)}(e,n),e)}export{k as downloadZip,j as makeZip,C as predictLength};
